<!-- ✅ 팝업이 삽입될 컨테이너 -->
<div id="popup-container"></div>

<!-- ✅ 전체화면 폭죽 캔버스 (index에 1개만) -->
<canvas id="confettiFullscreen" style="
  position:fixed; inset:0; width:100%; height:100%;
  pointer-events:none; z-index:10000; display:none;"></canvas>

<!-- Swiper (index에서 1번만) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js"></script>

<script>
/* =========================
   1) 전체화면 폭죽 엔진 (1.8초 반복 발사)
========================= */
(function(){
  const canvas = document.getElementById('confettiFullscreen');
  if(!canvas) return console.error('confettiFullscreen 없음');
  const ctx = canvas.getContext('2d');

  const DPR = Math.min(2, window.devicePixelRatio || 1);
  const colors = ['#ff4d4d','#ffd166','#06d6a0','#4dabf7','#b197fc','#f783ac','#ffffff'];

  let particles = [];
  let rafId = null;
  let intervalId = null;
  let running = false;

  function rand(min, max){ return Math.random() * (max - min) + min; }

  function resize(){
    canvas.width  = Math.floor(innerWidth * DPR);
    canvas.height = Math.floor(innerHeight * DPR);
    canvas.style.width  = innerWidth + 'px';
    canvas.style.height = innerHeight + 'px';
    ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
    ctx.clearRect(0, 0, innerWidth, innerHeight);
  }

  function burst(){
    const x = rand(innerWidth * 0.2, innerWidth * 0.8);
    const y = innerHeight * 0.2;

    for(let i=0;i<200;i++){
      const size = rand(4, 10);
      particles.push({
        x, y,
        vx: rand(-7, 7),
        vy: rand(-14, -5),
        g: rand(0.18, 0.35),
        drag: 0.985,
        w: size,
        h: size * rand(0.6, 1.7),
        rot: rand(0, Math.PI*2),
        vr: rand(-0.22, 0.22),
        color: colors[(Math.random() * colors.length) | 0],
        life: rand(70, 150)
      });
    }
  }

  function tick(){
    if(!running) return;
    ctx.clearRect(0, 0, innerWidth, innerHeight);

    particles = particles.filter(p => p.life > 0 && p.y < innerHeight + 60);

    for(const p of particles){
      p.life -= 1;
      p.vx *= p.drag;
      p.vy = p.vy * p.drag + p.g;

      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;

      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
    }
    rafId = requestAnimationFrame(tick);
  }

  window.startConfettiLoop = function(){
    window.stopConfettiLoop();
    canvas.style.display = 'block';
    resize();
    running = true;
    burst();
    rafId = requestAnimationFrame(tick);
    intervalId = setInterval(burst, 1800); // ✅ 1.8초
  };

  window.stopConfettiLoop = function(){
    if(intervalId){ clearInterval(intervalId); intervalId = null; }
    if(rafId){ cancelAnimationFrame(rafId); rafId = null; }
    running = false;
    particles = [];
    ctx.clearRect(0, 0, innerWidth, innerHeight);
    canvas.style.display = 'none';
  };

  window.addEventListener('resize', () => { if(running) resize(); });
})();


/* =========================
   2) popup.html 로딩 + 팝업/Swiper/폭죽 제어 (index에서만)
========================= */
document.addEventListener("DOMContentLoaded", () => {

  // ✅ 노출 기간 (원하면 수정)
  const startDate = new Date("2025-10-09T00:00:00");
  const endDate   = new Date("2026-10-10T12:59:59");
  const today     = new Date();
  if (today < startDate || today > endDate) return;

  fetch("https://cnt-mh.github.io/MH/DEV/APT/EXPO/popup.html?ver=" + Date.now())
    .then(res => res.text())
    .then(html => {
      const container = document.getElementById("popup-container");
      container.innerHTML = html;

      const wrap = document.getElementById("popup-wrap");
      const closeBtn = document.getElementById("popup-confirm");

      if (!wrap) return console.error("popup-wrap 없음: popup.html 구조 확인 필요");

      // 팝업 표시
      wrap.style.display = "flex";

      // 폭죽 시작
      window.startConfettiLoop?.();

      // popup 내부 Swiper 초기화 (삽입 후)
      try {
        new Swiper('.shorts-swiper', {
          loop: true,
          slidesPerView: 1,
          spaceBetween: 10,
          pagination: { el: '.swiper-pagination', clickable: true },
        });
      } catch(e) {
        console.error("popup swiper init error:", e);
      }

      // 닫기
      closeBtn?.addEventListener("click", () => {
        wrap.style.display = "none";
        window.stopConfettiLoop?.();
      });
    })
    .catch(err => console.error("popup load error:", err));
});
</script>
