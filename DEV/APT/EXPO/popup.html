<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>popup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css"/>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    .popup-wrap {
      background-color: rgba(0,0,0,.4);
      justify-content: center;
      align-items: center;
      position: fixed;
      inset: 0;
      display: none;
      padding: 15px;
      z-index: 9999;
    }
    .popup {
      width: 90%;
      max-width: 500px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 5px 10px 10px 1px rgba(0,0,0,.3);
      background: #fff;
      color: #000;
    }
    .popup-body { text-align:center; font-weight:bold; }

    .popup-foot {
      display:flex; border-top:.1px solid #ccc; height:50px;
    }
    .pop-btn {
      flex:1; display:flex; justify-content:center; align-items:center;
      cursor:pointer; font-weight:bold; background:#cdcdcd; color:#fff;
      transition: transform .05s ease, opacity .05s ease;
    }
    .pop-btn:active { transform:scale(.97); opacity:.8; }

    .thumb-slide {
      position: relative;
      overflow: hidden;
      border-radius: 10px;
      display: block;
    }

    .thumb-slide img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 10px;
    }

    .swiper-pagination {
      position: relative;
      margin-top: 8px;
      text-align: center;
    }

    .swiper-pagination-bullet {
      width: 10px;
      height: 10px;
      background: #818181;
      opacity: 1;
      margin: 0 5px !important;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255);
      transition: all .3s ease;
    }

    .swiper-pagination-bullet-active {
      background: #007aff;
      border: none;
      transform: scale(1.4);
    }

    /* ✅ 전체화면 폭죽 캔버스 */
    #confettiFullscreen{
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10000; /* 팝업(9999) 위 */
      display: none;
    }
  </style>
</head>

<body>

  <!-- ✅ 전체화면 폭죽 캔버스 -->
  <canvas id="confettiFullscreen"></canvas>

  <!-- ✅ 팝업 -->
  <div class="popup-wrap" id="popup-wrap">
    <div class="popup">
      <div class="popup-body" style="padding:0px;"></div>

      <div class="shorts-swiper swiper">
        <div class="swiper-wrapper" id="shortsContainer">
          <div class="swiper-slide">
            <div class="thumb-slide">
              <img src="https://raw.githubusercontent.com/CNT-MH/MH/main/DEV/APT/EXPO/AS/board/PNG/1223.png" alt="이미지">
            </div>
          </div>
        </div>
        <!-- <div class="swiper-pagination"></div> -->
      </div>

      <div class="popup-foot">
        <div class="pop-btn" id="popup-confirm">확인</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js"></script>

  <script>
  /* =========================================================
     A) 전체화면 폭죽 엔진 (반복발사 1.8초 간격)
     - startConfettiLoop(): 시작
     - stopConfettiLoop(): 정리(타이머/RAF/파티클/캔버스)
  ========================================================= */
  (() => {
    const canvas = document.getElementById('confettiFullscreen');
    const ctx = canvas.getContext('2d');

    const DPR = Math.min(2, window.devicePixelRatio || 1);
    const colors = ['#ff4d4d','#ffd166','#06d6a0','#4dabf7','#b197fc','#f783ac','#ffffff'];

    let particles = [];
    let rafId = null;
    let intervalId = null;
    let running = false;

    function rand(min, max){ return Math.random() * (max - min) + min; }

    function resize(){
      canvas.width  = Math.floor(innerWidth * DPR);
      canvas.height = Math.floor(innerHeight * DPR);
      canvas.style.width  = innerWidth + 'px';
      canvas.style.height = innerHeight + 'px';
      ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
      ctx.clearRect(0, 0, innerWidth, innerHeight);
    }

    function burst(){
      const x = rand(innerWidth * 0.2, innerWidth * 0.8);
      const y = innerHeight * 0.2;

      for(let i=0;i<200;i++){
        const size = rand(4, 10);
        particles.push({
          x, y,
          vx: rand(-7, 7),
          vy: rand(-14, -5),
          g: rand(0.18, 0.35),
          drag: 0.985,
          w: size,
          h: size * rand(0.6, 1.7),
          rot: rand(0, Math.PI*2),
          vr: rand(-0.22, 0.22),
          color: colors[(Math.random() * colors.length) | 0],
          life: rand(70, 150)
        });
      }
    }

    function tick(){
      if(!running) return;

      ctx.clearRect(0, 0, innerWidth, innerHeight);
      particles = particles.filter(p => p.life > 0 && p.y < innerHeight + 60);

      for(const p of particles){
        p.life -= 1;
        p.vx *= p.drag;
        p.vy = p.vy * p.drag + p.g;

        p.x += p.vx;
        p.y += p.vy;
        p.rot += p.vr;

        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot);
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
        ctx.restore();
      }

      rafId = requestAnimationFrame(tick);
    }

    window.startConfettiLoop = function(){
      window.stopConfettiLoop();     // 중복 방지
      canvas.style.display = 'block';
      resize();

      running = true;
      burst();                       // 즉시 1회 발사
      rafId = requestAnimationFrame(tick);

      // ✅ 1.8초 간격 반복 발사
      intervalId = setInterval(burst, 1800);
    };

    window.stopConfettiLoop = function(){
      if(intervalId){ clearInterval(intervalId); intervalId = null; }
      if(rafId){ cancelAnimationFrame(rafId); rafId = null; }
      running = false;
      particles = [];
      ctx.clearRect(0, 0, innerWidth, innerHeight);
      canvas.style.display = 'none';
    };

    window.addEventListener('resize', () => {
      if(running) resize();
    });
  })();


  /* =========================================================
     B) 팝업 표시/닫기 + 폭죽 연동 (중복 로직 제거한 단일 버전)
     - 팝업이 열릴 때: startConfettiLoop()
     - 확인 버튼(닫기) : stopConfettiLoop()
     - 노출기간/오늘닫기 로직 포함
  ========================================================= */
  document.addEventListener("DOMContentLoaded", () => {

    // ✅ 노출 기간
    const startDate = new Date("2025-10-09T00:00:00");
    const endDate   = new Date("2026-10-10T12:59:59");
    const today     = new Date();

    if (today < startDate || today > endDate) return;

    // ✅ 오늘 닫았는지(localStorage) - 필요하면 주석 해제
    // const todayString = today.toDateString();
    // if (localStorage.getItem("popupClosedDate") === todayString) return;

    const wrap = document.getElementById("popup-wrap");
    const closeBtn = document.getElementById("popup-confirm");

    // ✅ 팝업 오픈
    if (wrap) wrap.style.display = "flex";

    // ✅ 폭죽 시작
    if (typeof window.startConfettiLoop === "function") {
      window.startConfettiLoop();
    }

    // ✅ Swiper 초기화(팝업 표시 후)
    new Swiper('.shorts-swiper', {
      loop: true,
      slidesPerView: 1,
      spaceBetween: 10,
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
    });

    // ✅ 닫기(확인) 클릭
    if (closeBtn) {
      closeBtn.addEventListener("click", () => {
        if (wrap) wrap.style.display = "none";

        // ✅ 폭죽 정리
        if (typeof window.stopConfettiLoop === "function") {
          window.stopConfettiLoop();
        }

        // ✅ 오늘 닫기 저장(필요하면 주석 해제)
        // localStorage.setItem("popupClosedDate", todayString);
      });
    }
  });
  </script>
</body>
</html>